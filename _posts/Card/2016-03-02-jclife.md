---
layout:     post
title:      Java Card applet 的生命周期
category: Card
description: Java Card Applet Lifetime
---

本文所指的Applet是为Java Card所写的Applet，与通常所说的Java Applet不是一回事。  
一个Java卡实例的生命周期起始于JCRE（Java Card Runtime Environment) 通过Applet.register注册，结束于删除；JCRE通过 Applet的install、select、 deselect和 process与Applet进行交互。  

  * install方法  

当Applet实例创建时，JCRE不会直接调用构造函数，而是通过调用静态方法install(byte[], short, byte);如果install方法没有实现，那么Applet对象就无法被创建。  
当方法install(byte[], short, byte)被调用时， applet实例还没有被创建。 applet中的install方法的主要任务是使用applet子类的构造器创建它的实例，并注册这个实例。  
Applet.register方法或Applet.register(byte[], short, byte)方法用于指定applet的AID。  

  * select方法  

如果没有选中applet，那么applet都处于空闲状态，在JCRE调用select()方法之前，先要调用deselect()方法来释放之前选中的applet；select()方法可以根据不同的条件来返回true或者是false或者抛出一个异常，如果返回了true那么就代表这个applet被选中了，后续的指令都会通过process()方法来处理。

另外需要注意的一点是，当选中了applet时，selectingApplet()方法会返回true，使用selectingApplet()方法便可与process()方法中的其它select方法区分开，用法见下文代码。  

  * process方法  

选择applet后，后续的APDU指令会通过本方法来处理，但某些优先级较高的指令除外，比如：MANAGE CHANNEL指令会被Java Card平台优先处理。该方法必须实现。  

  * deselect方法  

用来取消applet的选定，deselect()方法允许applet来清空一些Ram变量即CLEAR\_ON\_DESELECT；当执行deslect()方法执行时selectingApplet()方法会返回false。  

  * uninstall方法  

当JCRE删除实例时会调用该方法，由于静态属性属于类，因此在此方法中可能包含一些对于静态属性的处理。  


源码及注释：  
``` java

package im.map.card;

import javacard.framework.Applet;  
import javacard.framework.ISO7816;  
import javacard.framework.ISOException;  
import javacard.framework.APDU;  
import javacard.framework.Util;  

public class myCard extends Applet {

	public static void install(byte[] bArray, short bOffset, byte bLength) {     

	// GP-compliant JavaCard applet registration

	new myCard().register(bArray, (short) (bOffset + 1), bArray[bOffset]);

	}

	public void process(APDU apdu) {

		if (selectingApplet()) {           //当然也可以在return前进行其它处理使其返回FCI+SW，默认只返回SW。
			return;

		//ISOException.throwIt(ISO7816.SW\_NO\_ERROR);   //也可以把return屏蔽，把这一行放开，作用一样，便于理解。

	}	

	byte[] buf = apdu.getBuffer();

	if(buf[ISO7816.OFFSET_INS]==(byte)0xCC)           //根据INS进入不同方法

		CMD_CC(apdu);

	else if(buf[ISO7816.OFFSET_INS]==(byte)0xA4)

		ISOException.throwIt(ISO7816.SW\_FILE\_NOT\_FOUND);  //如果选择的不是applet并且进入了该process则返回6A82，即SW\_FILE\_NOT\_FOUND

	if(buf[ISO7816.OFFSET_INS]==(byte)0xCC)

		CMD_CC(apdu);

	else if(buf[ISO7816.OFFSET_INS]==(byte)0xA4)

		ISOException.throwIt(ISO7816.SW\_FILE\_NOT_FOUND);

	else

		ISOException.throwIt(ISO7816.SW\_INS\_NOT\_SUPPORTED);     //其它进入process的INS返回6D00，即SW\_INS\_NOT\_SUPPORTED

	}

	public void CMD_CC(APDU apdu)        //用于返回固定值1122

	{

		byte[] buf = apdu.getBuffer();

		Util.setShort(buf,(short)0,(short)0x1122);  //赋值函数，从数组下标0开始，复制两字节的数据0x1122给buf

		apdu.setOutgoingAndSend((short)0,(short)2);      //返回数据

	}

	//select deselect uninstall方法默认可不实现。

}

``` 


参考文档：Runtime Environment Specification -Java Card™ Platform, Version 2.2.2  
